


// 22nd December, 2022

// Sematic Search

// creating mapping for job posting index
// dense vector field type used for job_vector key, supports knn search
// The dense_vector type does not support aggregations or sorting.
// not specifying #shards and #replicas in test, consider in production

// Dense vector fields cannot be indexed if they are within nested mappings.

DELETE posting


// 1. approximate knn


PUT posting
{
  "mappings": {
    "properties": {
      "jobs_vector": {
        "type": "dense_vector",
        "dims": 384,
        "index": true,
        "similarity": "dot_product"
      }
    }
  }
}


GET posting/_mapping

GET posting/_search


// simple search query using knn
GET posting/_search
{
  "knn": {
    "field": "jobs_vector",
    "k": 10,
    "num_candidates": 100,
    "filter": {
      "match": {
        "Eligibility": "everyone"
      }
    },
    "query_vector": [
      -0.0353823453,
      0.00459872419,
      0.00323026697,
      -0.0271464661,
      0.0524477996,
      -0.00412573433,
      -0.0404219106,
      0.0151387928,
      -0.0200076438,
      -0.0486902073,
      -0.0456279926,
      0.0260759182,
      0.05091675,
      -0.0929600224,
      0.0000310681935,
      0.0106144268,
      0.0143560711,
      0.0126965651,
      0.00291034952,
      -0.0483885072,
      -0.0896450952,
      0.00495181419,
      -0.00109770847,
      -0.00885082129,
      0.0675866529,
      0.0331269018,
      0.137225389,
      0.00763270585,
      -0.031455297,
      -0.0953883603,
      -0.0271483194,
      -0.0587516017,
      -0.0460167043,
      -0.0338456146,
      -0.0328866877,
      0.117446616,
      0.047758285,
      -0.0399369895,
      -0.0267749615,
      -0.0345182382,
      -0.0469718426,
      -0.0133860903,
      -0.00956854317,
      0.0224821437,
      0.0151036698,
      -0.0636037961,
      0.00609930046,
      -0.104082309,
      0.00890981779,
      -0.072559163,
      0.0324203037,
      -0.0495133922,
      0.00449187914,
      -0.111902624,
      -0.0103658959,
      0.0699374005,
      0.00555508677,
      0.0662864074,
      -0.0483474284,
      0.0113182003,
      0.0413340628,
      -0.0418296084,
      0.0251779631,
      0.0302414261,
      0.0355293117,
      -0.0628234819,
      0.0256315339,
      0.0455756411,
      -0.00589086814,
      -0.126318902,
      0.0158397239,
      -0.0628010258,
      -0.0325992852,
      -0.0330272727,
      0.0500057265,
      -0.0196996089,
      0.056741491,
      0.00320315221,
      0.0593863577,
      -0.0230148733,
      0.0278607886,
      -0.0182837248,
      -0.087457478,
      0.0359093212,
      -0.00846435595,
      0.0672377199,
      0.0463645943,
      0.126120463,
      0.0747310147,
      0.0114362575,
      0.0847932547,
      0.0578730367,
      0.0318897925,
      0.0834187567,
      0.0369187705,
      0.00164653594,
      0.0668946579,
      -0.0422937684,
      -0.0273382161,
      0.0897029042,
      -0.0124208257,
      0.0200610962,
      0.0889794379,
      -0.00399004808,
      -0.0558354147,
      -0.00655307155,
      0.0368307605,
      0.000332406082,
      -0.022388706,
      -0.0729346797,
      0.031864848,
      0.0387420282,
      0.0142776249,
      -0.0120902034,
      0.0531347208,
      -0.0625819266,
      -0.101527534,
      -0.0303834435,
      0.0541698001,
      -0.0606123507,
      0.0139545733,
      0.104541682,
      -0.0266338624,
      0.032126423,
      0.0416136533,
      -0.0416048802,
      -0.00298780273,
      1.0495927e-30,
      -0.00781102898,
      0.0922469422,
      0.0104033593,
      -0.0024022602,
      -0.0139310705,
      -0.0183169469,
      -0.0166560896,
      0.0513642579,
      0.0347070731,
      0.00434656255,
      -0.0141114974,
      0.0409504734,
      -0.0119040543,
      0.0692262501,
      0.0965434164,
      -0.0544669032,
      -0.00313779153,
      0.0233882181,
      0.035030622,
      0.0204075892,
      -0.00125322689,
      -0.0726359114,
      -0.0239250232,
      0.0114910742,
      0.0319526009,
      -0.0130768297,
      0.0423796177,
      -0.00756107457,
      -0.000604705245,
      0.0111857019,
      0.0203071591,
      0.059988793,
      0.0677157417,
      -0.0126956683,
      -0.0482448526,
      -0.0139175821,
      -0.0803893059,
      -0.0175325647,
      0.019647155,
      0.0152117684,
      0.0112369033,
      0.0586917326,
      -0.00396902626,
      -0.0207324419,
      0.0387407206,
      -0.0562841035,
      0.0191013925,
      -0.0340246037,
      0.0606716722,
      -0.03151251,
      -0.071942009,
      0.0250915438,
      0.0536437146,
      -0.0161778089,
      0.0518871285,
      -0.00139745756,
      0.109215856,
      0.0405047461,
      0.0159968864,
      0.117501564,
      -0.0695202351,
      0.0806952938,
      -0.0261856057,
      0.0515747294,
      -0.0619280823,
      -0.00515395077,
      0.0191517808,
      0.0258546248,
      0.0427514873,
      -0.00392283546,
      -0.0940069035,
      -0.0740910396,
      0.0157296173,
      0.0229991749,
      -0.0356997028,
      0.0349386707,
      -0.115317099,
      0.0124096898,
      -0.000315150421,
      -0.0349351577,
      -0.0430936962,
      0.0606127046,
      -0.0158477239,
      -0.0848137811,
      0.196102455,
      0.0378258564,
      -0.00819388963,
      -0.0584418662,
      0.0655952394,
      0.0872178823,
      -0.0946468785,
      -0.0623805784,
      0.0250586104,
      0.024437828,
      -0.033912085,
      -2.37249253e-33,
      -0.129673272,
      0.00164231786,
      -0.0687120631,
      -0.0650890246,
      0.0431931429,
      0.0095194364,
      0.0207361877,
      0.039462246,
      0.00654263794,
      0.0531559326,
      0.0249299351,
      -0.0211151578,
      0.0461305343,
      -0.0199015308,
      -0.0421557389,
      0.0555821359,
      -0.0726435706,
      -0.0860067159,
      0.00167103612,
      -0.0496170335,
      0.00961968582,
      -0.0191425141,
      -0.0121321287,
      0.000737348339,
      0.0262405761,
      -0.0434419177,
      0.0561191402,
      -0.0539440364,
      -0.0554900505,
      -0.028935656,
      -0.00284025609,
      -0.0704868361,
      -0.00902066473,
      0.106546745,
      -0.0584945008,
      -0.0180544835,
      -0.0375144333,
      0.0532743186,
      0.0447841585,
      -0.040757183,
      0.0184227526,
      -0.0194366146,
      0.0213871673,
      -0.0248563364,
      -0.0731136054,
      -0.0771150813,
      -0.0924138352,
      -0.0438124053,
      -0.0504243746,
      -0.00475970004,
      0.00716548739,
      0.0954878628,
      0.0801380947,
      -0.0849876031,
      -0.0171337966,
      -0.0579865016,
      -0.00564703997,
      0.0449884012,
      -0.00192618987,
      0.0170421731,
      0.00698729511,
      0.0525254123,
      0.128252551,
      0.0498146228,
      -0.0305680316,
      -0.0322890282,
      -0.0382121131,
      0.0195885897,
      -0.0882426798,
      -0.0580655895,
      0.0347830877,
      0.00906122383,
      -0.0502353869,
      -0.0154931443,
      -0.0416940525,
      -0.0889708102,
      -0.0866186917,
      -0.0390414074,
      -0.0463958234,
      0.047629904,
      0.0272651538,
      0.0241272356,
      0.0194873884,
      0.076053746,
      -0.0168008227,
      -0.0253247265,
      -0.0384347588,
      0.0242707487,
      0.0654295757,
      -0.057504762,
      -0.017819928,
      -0.0127458051,
      -0.0820218399,
      0.035986837,
      0.00212938362,
      -2.56016351e-33,
      -0.0584513135,
      0.021283295,
      0.0469595119,
      0.00240596198,
      -0.0702277422,
      -0.0208976176,
      -0.0560734347,
      0.0433216132,
      -0.00191020686,
      -0.112079807,
      -0.00490137935,
      -0.0662707612,
      -0.0130332001,
      0.101227492,
      0.0199232511,
      0.0259297863,
      -0.000648501096,
      0.0568919443,
      0.0327208675,
      -0.105276771,
      0.0244592149,
      0.0226019043,
      0.0113301519,
      0.0919840708,
      0.0483612232,
      0.00189070101,
      -0.051168438,
      -0.0439019687,
      -0.0324418917,
      0.00306179235,
      0.04910722,
      -0.049313128,
      0.0469013639,
      -0.0331980661,
      0.114990346,
      -0.00050603447,
      0.0570416525,
      0.0714186057,
      0.00175018504,
      0.0856473595,
      0.000205255506,
      0.00368767045,
      0.0285886806,
      0.00125137391,
      0.042208802,
      -0.00915149506,
      -0.071170263,
      -0.0684801415,
      0.0313606411,
      -0.0435990021,
      0.0412820429,
      -0.0466092229,
      -0.0248693861,
      0.0181094054,
      0.0527654141,
      0.116748646,
      -0.0714002997,
      -0.0393289961,
      -0.064459607,
      -0.0218920279,
      -0.00747031765,
      0.00780509086,
      0.101571746,
      0.0103564067
    ]
  }
}
// The kNN search will return the top k documents that also match this filter.



// 2. brute force knn

PUT posting_brute_force
{
  "mappings": {
    "properties": {
      "jobs_vector": {
        "type": "dense_vector",
        "dims": 384
      }
    }
  }
}

// DELETE posting_brute_force

GET posting_brute_force/_search
GET posting_brute_force/_mapping


// search done using script score query
// Uses a script to provide a custom score for returned documents.


GET posting_brute_force/_search
{
  "query": {
    "script_score": {
      "query": {
        "bool": {
          "must": [
            {
              "match": {
                "Eligibility": "everyone"
              }
            }
          ]
        }
      },
      "script": {
        "source": "cosineSimilarity(params.query_vector, 'jobs_vector') + 1.0", 
        "params": {
          "query_vector": [
      -0.0353823453,
      0.00459872419,
      0.00323026697,
      -0.0271464661,
      0.0524477996,
      -0.00412573433,
      -0.0404219106,
      0.0151387928,
      -0.0200076438,
      -0.0486902073,
      -0.0456279926,
      0.0260759182,
      0.05091675,
      -0.0929600224,
      0.0000310681935,
      0.0106144268,
      0.0143560711,
      0.0126965651,
      0.00291034952,
      -0.0483885072,
      -0.0896450952,
      0.00495181419,
      -0.00109770847,
      -0.00885082129,
      0.0675866529,
      0.0331269018,
      0.137225389,
      0.00763270585,
      -0.031455297,
      -0.0953883603,
      -0.0271483194,
      -0.0587516017,
      -0.0460167043,
      -0.0338456146,
      -0.0328866877,
      0.117446616,
      0.047758285,
      -0.0399369895,
      -0.0267749615,
      -0.0345182382,
      -0.0469718426,
      -0.0133860903,
      -0.00956854317,
      0.0224821437,
      0.0151036698,
      -0.0636037961,
      0.00609930046,
      -0.104082309,
      0.00890981779,
      -0.072559163,
      0.0324203037,
      -0.0495133922,
      0.00449187914,
      -0.111902624,
      -0.0103658959,
      0.0699374005,
      0.00555508677,
      0.0662864074,
      -0.0483474284,
      0.0113182003,
      0.0413340628,
      -0.0418296084,
      0.0251779631,
      0.0302414261,
      0.0355293117,
      -0.0628234819,
      0.0256315339,
      0.0455756411,
      -0.00589086814,
      -0.126318902,
      0.0158397239,
      -0.0628010258,
      -0.0325992852,
      -0.0330272727,
      0.0500057265,
      -0.0196996089,
      0.056741491,
      0.00320315221,
      0.0593863577,
      -0.0230148733,
      0.0278607886,
      -0.0182837248,
      -0.087457478,
      0.0359093212,
      -0.00846435595,
      0.0672377199,
      0.0463645943,
      0.126120463,
      0.0747310147,
      0.0114362575,
      0.0847932547,
      0.0578730367,
      0.0318897925,
      0.0834187567,
      0.0369187705,
      0.00164653594,
      0.0668946579,
      -0.0422937684,
      -0.0273382161,
      0.0897029042,
      -0.0124208257,
      0.0200610962,
      0.0889794379,
      -0.00399004808,
      -0.0558354147,
      -0.00655307155,
      0.0368307605,
      0.000332406082,
      -0.022388706,
      -0.0729346797,
      0.031864848,
      0.0387420282,
      0.0142776249,
      -0.0120902034,
      0.0531347208,
      -0.0625819266,
      -0.101527534,
      -0.0303834435,
      0.0541698001,
      -0.0606123507,
      0.0139545733,
      0.104541682,
      -0.0266338624,
      0.032126423,
      0.0416136533,
      -0.0416048802,
      -0.00298780273,
      1.0495927e-30,
      -0.00781102898,
      0.0922469422,
      0.0104033593,
      -0.0024022602,
      -0.0139310705,
      -0.0183169469,
      -0.0166560896,
      0.0513642579,
      0.0347070731,
      0.00434656255,
      -0.0141114974,
      0.0409504734,
      -0.0119040543,
      0.0692262501,
      0.0965434164,
      -0.0544669032,
      -0.00313779153,
      0.0233882181,
      0.035030622,
      0.0204075892,
      -0.00125322689,
      -0.0726359114,
      -0.0239250232,
      0.0114910742,
      0.0319526009,
      -0.0130768297,
      0.0423796177,
      -0.00756107457,
      -0.000604705245,
      0.0111857019,
      0.0203071591,
      0.059988793,
      0.0677157417,
      -0.0126956683,
      -0.0482448526,
      -0.0139175821,
      -0.0803893059,
      -0.0175325647,
      0.019647155,
      0.0152117684,
      0.0112369033,
      0.0586917326,
      -0.00396902626,
      -0.0207324419,
      0.0387407206,
      -0.0562841035,
      0.0191013925,
      -0.0340246037,
      0.0606716722,
      -0.03151251,
      -0.071942009,
      0.0250915438,
      0.0536437146,
      -0.0161778089,
      0.0518871285,
      -0.00139745756,
      0.109215856,
      0.0405047461,
      0.0159968864,
      0.117501564,
      -0.0695202351,
      0.0806952938,
      -0.0261856057,
      0.0515747294,
      -0.0619280823,
      -0.00515395077,
      0.0191517808,
      0.0258546248,
      0.0427514873,
      -0.00392283546,
      -0.0940069035,
      -0.0740910396,
      0.0157296173,
      0.0229991749,
      -0.0356997028,
      0.0349386707,
      -0.115317099,
      0.0124096898,
      -0.000315150421,
      -0.0349351577,
      -0.0430936962,
      0.0606127046,
      -0.0158477239,
      -0.0848137811,
      0.196102455,
      0.0378258564,
      -0.00819388963,
      -0.0584418662,
      0.0655952394,
      0.0872178823,
      -0.0946468785,
      -0.0623805784,
      0.0250586104,
      0.024437828,
      -0.033912085,
      -2.37249253e-33,
      -0.129673272,
      0.00164231786,
      -0.0687120631,
      -0.0650890246,
      0.0431931429,
      0.0095194364,
      0.0207361877,
      0.039462246,
      0.00654263794,
      0.0531559326,
      0.0249299351,
      -0.0211151578,
      0.0461305343,
      -0.0199015308,
      -0.0421557389,
      0.0555821359,
      -0.0726435706,
      -0.0860067159,
      0.00167103612,
      -0.0496170335,
      0.00961968582,
      -0.0191425141,
      -0.0121321287,
      0.000737348339,
      0.0262405761,
      -0.0434419177,
      0.0561191402,
      -0.0539440364,
      -0.0554900505,
      -0.028935656,
      -0.00284025609,
      -0.0704868361,
      -0.00902066473,
      0.106546745,
      -0.0584945008,
      -0.0180544835,
      -0.0375144333,
      0.0532743186,
      0.0447841585,
      -0.040757183,
      0.0184227526,
      -0.0194366146,
      0.0213871673,
      -0.0248563364,
      -0.0731136054,
      -0.0771150813,
      -0.0924138352,
      -0.0438124053,
      -0.0504243746,
      -0.00475970004,
      0.00716548739,
      0.0954878628,
      0.0801380947,
      -0.0849876031,
      -0.0171337966,
      -0.0579865016,
      -0.00564703997,
      0.0449884012,
      -0.00192618987,
      0.0170421731,
      0.00698729511,
      0.0525254123,
      0.128252551,
      0.0498146228,
      -0.0305680316,
      -0.0322890282,
      -0.0382121131,
      0.0195885897,
      -0.0882426798,
      -0.0580655895,
      0.0347830877,
      0.00906122383,
      -0.0502353869,
      -0.0154931443,
      -0.0416940525,
      -0.0889708102,
      -0.0866186917,
      -0.0390414074,
      -0.0463958234,
      0.047629904,
      0.0272651538,
      0.0241272356,
      0.0194873884,
      0.076053746,
      -0.0168008227,
      -0.0253247265,
      -0.0384347588,
      0.0242707487,
      0.0654295757,
      -0.057504762,
      -0.017819928,
      -0.0127458051,
      -0.0820218399,
      0.035986837,
      0.00212938362,
      -2.56016351e-33,
      -0.0584513135,
      0.021283295,
      0.0469595119,
      0.00240596198,
      -0.0702277422,
      -0.0208976176,
      -0.0560734347,
      0.0433216132,
      -0.00191020686,
      -0.112079807,
      -0.00490137935,
      -0.0662707612,
      -0.0130332001,
      0.101227492,
      0.0199232511,
      0.0259297863,
      -0.000648501096,
      0.0568919443,
      0.0327208675,
      -0.105276771,
      0.0244592149,
      0.0226019043,
      0.0113301519,
      0.0919840708,
      0.0483612232,
      0.00189070101,
      -0.051168438,
      -0.0439019687,
      -0.0324418917,
      0.00306179235,
      0.04910722,
      -0.049313128,
      0.0469013639,
      -0.0331980661,
      0.114990346,
      -0.00050603447,
      0.0570416525,
      0.0714186057,
      0.00175018504,
      0.0856473595,
      0.000205255506,
      0.00368767045,
      0.0285886806,
      0.00125137391,
      0.042208802,
      -0.00915149506,
      -0.071170263,
      -0.0684801415,
      0.0313606411,
      -0.0435990021,
      0.0412820429,
      -0.0466092229,
      -0.0248693861,
      0.0181094054,
      0.0527654141,
      0.116748646,
      -0.0714002997,
      -0.0393289961,
      -0.064459607,
      -0.0218920279,
      -0.00747031765,
      0.00780509086,
      0.101571746,
      0.0103564067
    ] 
        }
      }
    }
  }
}






